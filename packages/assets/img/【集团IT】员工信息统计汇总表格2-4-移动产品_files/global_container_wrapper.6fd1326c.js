(window.webpackJsonplizard_service_sheet=window.webpackJsonplizard_service_sheet||[]).push([[3],{577:function(t,e,n){"use strict";n.d(e,"a",function(){return o});var i=n(32);function o(){return{type:i.a.collabModal.hidden}}},753:function(t,e,n){"use strict";n.r(e);var i,o=n(27),r=n(555),c=n(299),a=n.n(c),u=n(20),s=n.n(u),p=n(143),b=n(5),l=n(1133),f=n(146),d=n.n(f),g=d()({loader:function(){return n.e(8).then(n.bind(null,1136))},loading:function(){return s.a.createElement("div",{style:{width:"530px"}})}}),h=d()({loader:function(){return n.e(0).then(n.bind(null,1137))},loading:function(){return s.a.createElement("div",{style:{width:"480px"}})}});function O(){return null!==i&&i.apply(this,arguments)||this}var _=(i=u.Component,Object(b.__extends)(O,i),O.prototype.render=function(){var t=this.props,e=t.inSpace,n=Object(b.__rest)(t,["inSpace"]);return e?s.a.createElement(g,Object(b.__assign)({},n)):s.a.createElement(h,Object(b.__assign)({},n))},O=Object(b.__decorate)([Object(l.a)(function(t,e){var n=e.file?e.file:t.ui.collabModal.file;return{inSpace:n.isFromSVC||n.isSpace}})],O)),v=(n(577),_),N=n(1),j=n.n(N),m=n(2),I=n(190),k=n(0);var C,y=n(16),T=n(6),E=Object(m.c)(k.a.SET_UNPEEKED_COUNT,function(i){return function(t){var e=t.emitter,n=t.next;return e.emit("unpeekedCount.changed",i),n(i),i}}),S=Object(m.c)(k.a.GET_UNPEAKED_NOTIFICATION_COUNT,function(){return Object(y.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(T.get)("notifications/unpeeked_count",{background:!0})).then(n)},"getUnpeekedNotificationCount")}),w=(Object(m.c)(k.a.GET_UNREAD_NOTIFICATION_COUNT,function(){return Object(y.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(T.get)("notifications/unread_count",{background:!0})).then(n)},"getUnreadNotificationCount")}),Object(m.c)(k.a.GET_NOTIFICATIONS,function(t){var e=t.status,a=void 0===e?"all":e,n=t.prepend,u=void 0!==n&&n,i=t.peek,s=void 0!==i&&i;return Object(y.a)(function(t){var e=t.dispatch,n=t.next,i=(0,t.getState)();if(!u&&!function(t,e){var n=t.notifications.get(e+"HasMore");return"boolean"!=typeof n||n}(i,a))return Promise.resolve();var o="notifications?limit="+m.a+"&status="+a,r=function(t,e){return t.notifications.get(e)}(i,a),c=r&&r.size;return c&&!u&&(o+="&lt="+r.last().id),s&&(e(E(0)),o+="&action=peek"),e(Object(T.get)(o)).then(function(t){var e=u&&c?null:t.length===m.a;n({status:a,prepend:u,peek:s,items:t,hasMore:e})})},"getNotifications_"+a+"_"+u+"_"+s)})),U=Object(m.c)(k.a.MARK_NOTIFICATIONS_READ,function(i){return function(t){var e=t.dispatch,n=t.next;return e(Object(T.patch)("notifications/"+i+"?status=read")).then(function(){return n(i)})}}),x=(Object(m.c)(k.a.MARK_NOTIFICATIONS_ALL_READ,function(){return function(t){var e=t.dispatch,n=t.next;return e(Object(T.post)("notifications/action/read_all")).then(function(){return n(void 0)})}}),Object(m.c)(k.a.GET_SUBSCRIPTIONS,function(){return Object(y.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(T.get)("subscribe")).then(n)},"getSubscriptions")})),A=(Object(m.c)(k.a.SWITCH_SUBSCRIPTIONS,function(o,r){return function(t){var e=t.dispatch,n=t.next,i=r?"turnon":"turnoff";return e(Object(T.post)("subscribe",{body:{channel:o,action:i}})).then(function(t){return null===t||!0===t.success?void n({channel:o,on:r}):Promise.reject(new Error(j()("设置失败")))})}}),n(38)),M=n(40),D=0,R=1,F=2,P=3,L=4,G=5,K=6,z=7,H=8,B=9,J=20,q=(C=u.PureComponent,Object(b.__extends)(V,C),V.prototype.componentDidMount=function(){var e=this;this.props.getSubscriptions(),(window.shimo&&window.shimo.emitter||m.f).on("notification",function(t){e.props.getUnpeekedNotificationCount(),e.getMessage(t).then(function(t){t&&"undefined"!=typeof Notification&&Notification&&("granted"===Notification.permission?e.showNotification(t):Notification.requestPermission(function(t){return"granted"===t}).then(function(){e.showNotification(t)}))})})},V.prototype.componentDidUpdate=function(t){t.onLine!==this.props.onLine&&this.props.onLine&&this.props.getUnpeekedNotificationCount()},V.prototype.showNotification=function(t){var e=this;this.props.enableDesktopNotice&&new Notification(t.title,{tag:t.id+"",body:t.body,icon:t.icon}).addEventListener("click",function(){t.url&&window.open(t.url,"_blank"),e.props.markNotificationRead(t.id),e.props.setUnpeekedCount(e.props.notifications.get("unpeekedCount")-1)})},V.prototype.filterCurrentNotifications=function(e,t){if(t)return t.filter(function(t){return t.get("targetId")===e}).first()},V.prototype.getMessage=function(f){var d=this;return this.props.getNotifications({status:"unread",prepend:!0}).then(function(){var t=d.filterCurrentNotifications(f.target_id,d.props.notifications.get("unread"));if(!t)return null;var e=t.get("id"),n=t.getIn(["user","name"])||j()("未知用户"),i=t.getIn(["user","avatar"]),o=t.getIn(["file","name"]),r=t.get("link"),c=Object(M.a)(t.get("msg"));switch(f.type){case D:var a=t.getIn(["file","guid"]),u=t.getIn(["file","type"]),s=Object(A.getFileUrl)(u,a),p=s?r.replace("/"+a,s):r;return{id:e,title:j()(Q=Q||Object(b.__makeTemplateObject)([""," 评论了「","」"],[""," 评论了「","」"]),n,o),body:'"'+c+'"',icon:i,url:p};case H:var l=t.get("commentId");return{id:e,title:j()(X=X||Object(b.__makeTemplateObject)([""," 点赞了 ",""],[""," 点赞了 ",""]),n,c),body:o,icon:i,url:l?r+"-"+l:r};case z:case B:return{id:e,title:""+n,body:o,icon:i,url:r};case R:return{id:e,title:n+" "+c,body:o,icon:i,url:r};case F:case P:case L:case G:return{id:e,title:n+" "+c,icon:i,url:r};case K:return null;case J:return{id:e,title:j()("系统通知"),body:c,url:r}}})},V.prototype.render=function(){return null},V);function V(){return null!==C&&C.apply(this,arguments)||this}function W(t){var e=t.ui;return s.a.createElement(s.a.Fragment,null,e.collabModal.visible?s.a.createElement(v,null):null,!Object(o.isSelfHosted)()&&s.a.createElement(Z,null),s.a.createElement(r.default.ToastsContainer,null))}var Q,X,Y={getNotifications:w,getUnpeekedNotificationCount:S,markNotificationRead:U,getSubscriptions:x,setUnpeekedCount:E},Z=Object(p.connect)(function(t){return{onLine:Object(I.c)(t),notifications:t.notifications,enableDesktopNotice:t.subscriptions.desktop}},Y)(q);W.propTypes={ui:a.a.object};var $=Object(p.connect)(function(t){return{ui:t.ui}})(W);e.default=$}}]);
//# sourceMappingURL=global_container_wrapper.6fd1326c.js.map